# Deploy with: Render → Dashboard → New → Blueprint → Connect repo
# Then "Apply".

services:
  # --- API (FastAPI, Docker) ---
  - type: web
    name: cluesstack-api-fastapi
    env: docker
    plan: starter
    autoDeploy: true
    branch: main
    dockerfilePath: services/api-fastapi/Dockerfile
    healthCheckPath: /healthz
    envVars:
      # JWT
      - key: JWT_SECRET
        generateValue: true
      - key: JWT_ISS
        value: cluesstack
      - key: JWT_AUD
        value: cluesstack-app
      # Postgres (wired from DB)
      - key: POSTGRES_HOST
        fromDatabase:
          name: cluesstack-postgres
          property: host
      - key: POSTGRES_PORT
        fromDatabase:
          name: cluesstack-postgres
          property: port
      - key: POSTGRES_USER
        fromDatabase:
          name: cluesstack-postgres
          property: user
      - key: POSTGRES_PASSWORD
        fromDatabase:
          name: cluesstack-postgres
          property: password
      - key: POSTGRES_DB
        fromDatabase:
          name: cluesstack-postgres
          property: database
      # Redis (from Key Value service)
      - key: REDIS_URL
        fromService:
          name: cluesstack-redis
          type: keyvalue
          property: connectionString

  # --- Community (Node/Express or Next.js) ---
  - type: web
    name: cluesstack-community
    runtime: node
    plan: starter
    autoDeploy: true
    branch: main
    # If plain Express under services/community:
    buildCommand: npm ci --prefix services/community && npm run build --prefix services/community
    startCommand: npm run start --prefix services/community
    # If it's Next.js and you use "next start", keep the same build/start and set healthCheckPath to "/"
    healthCheckPath: /community/posts
    envVars:
      # JWT
      - key: JWT_SECRET
        generateValue: true
      - key: JWT_ISS
        value: cluesstack
      - key: JWT_AUD
        value: cluesstack-app
      # Postgres (same DB)
      - key: POSTGRES_HOST
        fromDatabase:
          name: cluesstack-postgres
          property: host
      - key: POSTGRES_PORT
        fromDatabase:
          name: cluesstack-postgres
          property: port
      - key: POSTGRES_USER
        fromDatabase:
          name: cluesstack-postgres
          property: user
      - key: POSTGRES_PASSWORD
        fromDatabase:
          name: cluesstack-postgres
          property: password
      - key: POSTGRES_DB
        fromDatabase:
          name: cluesstack-postgres
          property: database
      # Redis (optional)
      - key: REDIS_URL
        fromService:
          name: cluesstack-redis
          type: keyvalue
          property: connectionString

  # --- Redis as Key Value ---
  - type: keyvalue
    name: cluesstack-redis
    plan: free
    ipAllowList: []

databases:
  - name: cluesstack-postgres
    databaseName: cluesstack
    user: clues
    plan: free
    ipAllowList: []
