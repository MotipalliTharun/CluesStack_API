# Deploy with: Render → Dashboard → New → Blueprint → Connect repo
# Then "Apply" to provision all resources below.

envVarGroups:
  - name: jwt
    envVars:
      - key: JWT_SECRET
        generateValue: true
      - key: JWT_ISS
        value: cluesstack
      - key: JWT_AUD
        value: cluesstack-app

services:
  # --- API (FastAPI, Docker) ---
  - type: web
    name: cluesstack-api-fastapi
    env: docker
    plan: starter
    autoDeploy: true
    branch: main
    dockerfilePath: services/api-fastapi/Dockerfile
    healthCheckPath: /healthz
    envVarGroups:
      - jwt
    envVars:
      # Postgres (wired from DB)
      - key: POSTGRES_HOST
        fromDatabase:
          name: cluesstack-postgres
          property: host
      - key: POSTGRES_PORT
        fromDatabase:
          name: cluesstack-postgres
          property: port
      - key: POSTGRES_USER
        fromDatabase:
          name: cluesstack-postgres
          property: user
      - key: POSTGRES_PASSWORD
        fromDatabase:
          name: cluesstack-postgres
          property: password
      - key: POSTGRES_DB
        fromDatabase:
          name: cluesstack-postgres
          property: database
      # Redis (from Key Value service)
      - key: REDIS_URL
        fromService:
          name: cluesstack-redis
          type: keyvalue
          property: connectionString

  # --- Community (Node/Express) ---
  - type: web
    name: cluesstack-community
    runtime: node
    plan: starter
    autoDeploy: true
    branch: main
    # Adjust these to your repo layout + package.json scripts
    buildCommand: npm ci --prefix services/community && npm run build --prefix services/community
    startCommand: npm run start --prefix services/community
    healthCheckPath: /community/posts
    envVarGroups:
      - jwt
    envVars:
      # Postgres (same DB)
      - key: POSTGRES_HOST
        fromDatabase:
          name: cluesstack-postgres
          property: host
      - key: POSTGRES_PORT
        fromDatabase:
          name: cluesstack-postgres
          property: port
      - key: POSTGRES_USER
        fromDatabase:
          name: cluesstack-postgres
          property: user
      - key: POSTGRES_PASSWORD
        fromDatabase:
          name: cluesstack-postgres
          property: password
      - key: POSTGRES_DB
        fromDatabase:
          name: cluesstack-postgres
          property: database
      # Redis (optional for Express)
      - key: REDIS_URL
        fromService:
          name: cluesstack-redis
          type: keyvalue
          property: connectionString

  # Redis on Render as a "Key Value" service (kept as you had it)
  - type: keyvalue
    name: cluesstack-redis
    plan: free
    ipAllowList: []   # internal access only

databases:
  - name: cluesstack-postgres
    databaseName: cluesstack
    user: clues
    plan: free
    ipAllowList: []   # internal access only
